## 目标范围
本文档为使用收付通（简称SFT）的接入方开发者编写。
本文档的目标读者为接入方的技术实施人员，其中的部分内容也可供接入方的管理与业务人员参考。
本文档定义SFT接入方的接口，包括交易处理流程、通讯方式、报文格式、安全规范等。

## 通讯方式
### 通讯模式
接入方采用**HTTP+HMAC+HEAD+JSON**方式提交交易请求, SFT收到请求后, 先告知接入方请求已收到，并在完成了处理后，以HTTP+JSON的方式通知到接入方
URL:  http://sft.smartpay.com/interface

[hmac:32字节][head:37字节]{body:json}

接入方处理方式:
head =>   head字符串
pojo ==>  JSON字符串

head字符串 + JSON字符串 => byte数组1,
密钥 => byte数组2

将byte数组1, 数组2传入HmacMD5算法 算出hmac
hmac + byte数组1 + byte数组2 作为最终的post的http的body

平台处理方式:
1. 将受到http body按偏移量分为2部分: hmac, 剩余部分

2. head的前八个字节代表的是机构ID, 从head去除机构ID, 凭ID从数据库取出
接入方密钥,

3. 计算hmac, 并匹配hmac

4. hmac校验通过， 则将剩余部分发送到消息对列

### 应答模式
1、金融类交易采取**异步应答模式**
2、查询类交易采用**同步应答模式**

## 报文结构
这里报文结构是指接口数据的组织方式.
交易数据以HTTP协议承载，数据分为三个部分:

第一部分是为保证交易安全的HMAC

第二部分是代表交易基本信息的头部固定长度

第三部分是JSON格式的交易业务数据

### JSON业务数据
#### 1、JSON数据结构
```javascript
{
}
```
#### 2、报文头(5+4+8+6+8+6=37)

字段       |  解释         | 格式      | 备注
:---------|:-------------|:----------|: ----
  acc_id  | '99990001',  | char(8)   | 接入机构代码
  version | '1.0.0'      |  char(5)  | 版本号
  tcode   | '2001'       | char(4)   | 单笔代收
  ssn     | 'NNNNNN'     |  N6       | 机构流水号
  tdate   | '20141212',  | YYYYMMDD  | 机构交易日期
  ttime   | '121212',    |  HHMMSS   | 机构交易时间

#### 3、报文体
```javascript
// 单笔代收报文体
{
  callback => 'http://callback', // 回调地址(异步应答模式才有)
  btype => '0006',                      // 保险
  tamt  => '9999',                      // 交易金额
  acct_cat => '1',                      // 账户类型
  acct_name => '周超',                   // 账户名称
  acct_no   => '6226882100198883',      // 账号
}
```
#### 4、HMAC算法约定(128字节)
1. MAC算法采用标准的HmacMD5方式进行，密钥key事先约定好, 如果有条件,可在加密机中保存.
2. HmacSHA1以实现约定好的key和JSON业务数据包序列化后的子揭穿为参数, 计算出的MAC长度为160个字节，然后将这160个字节转换为hex编码
最为最后的HMAC

## 交易接口
### 数据元定义

1、请求数据元

字段        |  解释   | 格式  | 备注
:----------|:--------|:--------------
version    | 接口版本   |  char(5)  | 如1.0.1
tcode      | 交易代码   |  char(4)  |
btype      | 业务类型   |  char(4) | 如保险, 证券等
acc_id     | 接入方ID   |  char(8) | SFT给接入机构分配的代码
tamt       | 交易金额    |  N15 |
ssn        | 交易流水号  |  N6 |
tdate      | 交易日期    | YYYYMMDD |
ttime      | 交易时间    | HHMMSS |
callback   | 回调地址    | char(128) |
currency   | 货币种类    | N3   |  156人民币
acct_cat   | 账户类型    | N2  |
acct_name  | 账户名称    | CHR(64) |
acct_no    | 账号       |  N32  |
id_type    | 证件类型    | N2  |
id_no      | 证件号      | CHR(32)  |
bank_no    | 开户行联行号 | N12  |
bank_code  | 银行代码    |  char(16)  |
bank_name  | 开户行名称  | CHR(64) |

2、应答数据元

字段        |  解释    | 格式  | 备注
:----------|:--------|:--------------
sft_ssn    | 平台流水号 |   N6   |
sft_tdate  | 平台交易日期 | YYYYMMDD |
sft_ttime  | 平台交易时间 | HHMMSS |
resp_code  | 响应码     |  N6 |

### 接口定义

#### 单笔接口
异步应答交易(金融交易)
===
**单笔**


1、[单笔身份验证(1001)](sft-app-api/1001.md)
2、[单笔代收(2001)](sft-app-api/2001.md)
3、[单笔代付(3001)](sft-app-api/3001.md)

**批量**

1、[批量身份验证(1002)](sft-app-api/1002.md)
2、[批量代收(2002)](sft-app-api/2002.md)
3、[批量代付(3002)](sft-app-api/3002.md)

同步应答交易(查询)
===

**单笔**

[单笔身份验证查询(1011)](sft-app-api/1011.md)
[单笔代收查询(2011)](sft-app-api/2011.md)
[单笔代付查询(3011)](sft-app-api/3011.md)

**批量**

[批量身份验证查询(1012)](sft-app-api/1012.md)
[批量代收查询(2012)](sft-app-api/2012.md)
[批量代付查询(3012)](sft-app-api/3012.md)  

## 字典表
1、业务类型(btype)

业务代码 | 说明
:----------- | :-----------
0001    | 传统
0002    | 基金
0003    | 理财
0004    | 信托
0005    | 贵金属
0006    | 保险
0007    | 证券


2、交易代码
交易由四位组成, 各位含义如下

  位置   | 说明  | 备注
:------ | :-------| :-----  
   1    | 交易类别  | 1-身份认证类交易,2-代收,3-代付
   2    | 保留     |
   3    | 查询-金融 | 0-金融交易, 2-查询交易
   4    | 单笔-批量 | 1-单笔, 2-批量
如: 3012批量代付查询， 是代付(3),查询(1),批量(2)

交易代码表(tcode)

交易代码  | 说明
:------ | :-----------  
1001    | 身份认证
1011    | 单笔身份认证查询
1002    | 批量身份认证
1012    | 批量身份认证查询
2001    | 代收
2011    | 代收查询
2002    | 批量代收
2012    | 批量代收查询
3001    | 代付
3011    | 代付查询
3002    | 批量代付
3012    | 批量代付查询

3、账户类型(acct_cat)

代码 | 描述
:---| :-----------  
01  | 借记卡
02  | 贷记卡
03  | 准贷记卡
04  | 存折
05  | 对公账户
06  | 预付费账户

4、货币代码(currency)

代码  | 描述
:----| :-----
156  | 人民币

5、证件类型

代码  | 描述
:--- | :-------
01	 | 身份证
02	 | 军官证
03	 | 护照
04   | 回乡证
05	 | 台胞证
06	 | 警官证
07	 | 士兵证
99	 | 其它证件

6、银行代码(bank_code)

代码  | 描述
:--- | :-------
CCB	 | 建设银行
ICBC | 工商银行
CMB  | 招商银行
ABC  | 农业银行
HSBC | 汇丰银行
CEB  | 广大银行

5、响应码(resp_code)

交易代码  | 描述
:------ | :-----------
000000  | 交易成功
100000  | 处理中
210000  |
220000  |
230000  |
